name: Enforce PR Template (dev -> main)
on:
  pull_request_target:
    types: [opened, edited, synchronize]
    branches: ["main"]

permissions:
  pull-requests: write
  contents: read

jobs:
  enforce:
    if: ${{ github.event.pull_request.head.ref == 'dev' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout default branch contents
        uses: actions/checkout@v4
        with:
          # pull_request_target ì»¨í…ìŠ¤íŠ¸ì—ì„œëŠ” base ë ˆí¬ ë‚´ìš©ì„ ì²´í¬ì•„ì›ƒ
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Read PR template into env
        id: read
        run: |
          echo "TEMPLATE<<'EOF'" >> $GITHUB_ENV
          cat .github/pull_request_template.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Ensure PR body contains template
        uses: actions/github-script@v7
        with:
          script: |
            const current = context.payload.pull_request.body || "";
            const template = process.env.TEMPLATE.trim();

            // ê°„ë‹¨í•œ íŒë³„: í…œí”Œë¦¿ì˜ í•µì‹¬ í—¤ë”ê°€ ì—†ìœ¼ë©´ ë®ì–´ì“°ê¸°
            const mustHave = "## ğŸ“Œ ìš”ì•½";
            if (!current.includes(mustHave)) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: template
              });
            }